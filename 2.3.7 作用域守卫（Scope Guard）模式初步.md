å¤ªå¥½äº†ï¼æˆ‘ä»¬ç°åœ¨è¿›å…¥ **2.3.7ï¼šä½œç”¨åŸŸå®ˆå«ï¼ˆScope Guardï¼‰æ¨¡å¼åˆæ­¥**ã€‚

è¿™æ˜¯ **RAII å“²å­¦çš„é«˜çº§åº”ç”¨**ï¼Œæä¾›ä¸€ç§**è½»é‡çº§ã€é€šç”¨**çš„æ–¹å¼åœ¨**ä½œç”¨åŸŸç»“æŸæ—¶æ‰§è¡Œä»»æ„æ¸…ç†ä»£ç **ã€‚ä½œä¸º Java å¼€å‘è€…ï¼Œä½ å¯èƒ½ä½¿ç”¨ `try-finally`ï¼Œè€Œ C++ çš„ Scope Guard åˆ©ç”¨**åŒ¿å lambda + RAII** å®ç°**æ›´ç®€æ´ã€æ›´å®‰å…¨**çš„æ¸…ç†é€»è¾‘ã€‚æŒæ¡ Scope Guardï¼Œèƒ½è®©ä½ åœ¨**æ— éœ€å®šä¹‰å®Œæ•´ RAII ç±»**çš„æƒ…å†µä¸‹ï¼Œè½»æ¾ç®¡ç†ä¸´æ—¶èµ„æºæˆ–æ‰§è¡Œæ¸…ç†æ“ä½œã€‚

æˆ‘ä»¬å°†ç»§ç»­ä¸¥æ ¼éµå¾ªä½ çš„å­¦ä¹ åå¥½ï¼š
- âœ… SMART ç›®æ ‡  
- âœ… ç»“æ„å…ˆè¡Œï¼ˆScope Guard åœ°å›¾ï¼‰  
- âœ… ç”Ÿæ´»åŒ–æ¯”å–»  
- âœ… åŠ¨æ‰‹ä¸ºç‹ï¼ˆå«åŸºç¡€/è¿›é˜¶/é™·é˜±é¢˜ï¼‰  
- âœ… èºæ—‹å¤ä¹ ï¼ˆè¡”æ¥ 2.3 å…¨ç³»åˆ— + Java ç»éªŒï¼‰  
- âœ… ä¸»åŠ¨ learning + å¤ç›˜

---

## ğŸ¯ KU 2.3.7ï¼šä½œç”¨åŸŸå®ˆå«ï¼ˆScope Guardï¼‰æ¨¡å¼

> **æ‰€å±é˜¶æ®µ**ï¼šPhase 2 â€” é¢å‘å¯¹è±¡ç¼–ç¨‹  
> **å‰ç½®çŸ¥è¯†**ï¼š2.3.1â€“2.3.6ï¼ˆRAII å…¨ç³»åˆ—ï¼‰ã€C++11 lambdaã€Java try-finally ç»éªŒ  
> **åç»­è¡”æ¥**ï¼š3.4ï¼ˆLambda æ•è·ï¼‰ã€5.1ï¼ˆä½œç”¨åŸŸå®ˆå«åº“ï¼‰  
> **é¢„è®¡è€—æ—¶**ï¼š2â€“3 å°æ—¶

---

### ğŸ§­ ä¸€ã€ç»“æ„å…ˆè¡Œï¼šScope Guard åœ°å›¾

```
2.3.7 Scope Guard æ¨¡å¼
â”œâ”€â”€ 1. åŸºæœ¬æ€æƒ³
â”‚   â”œâ”€â”€ 1.1 åœ¨ä½œç”¨åŸŸç»“æŸæ—¶æ‰§è¡Œæ¸…ç†ä»£ç 
â”‚   â”œâ”€â”€ 1.2 åŸºäº RAIIï¼ˆææ„å‡½æ•°è°ƒç”¨ lambdaï¼‰
â”‚   â””â”€â”€ 1.3 æ— éœ€å®šä¹‰å®Œæ•´ RAII ç±»
â”œâ”€â”€ 2. æ‰‹åŠ¨å®ç°
â”‚   â”œâ”€â”€ 2.1 åŒ¿å struct + lambda
â”‚   â”œâ”€â”€ 2.2 ææ„å‡½æ•°è°ƒç”¨ lambda
â”‚   â””â”€â”€ 2.3 ç¦æ­¢æ‹·è´ï¼ˆç¡®ä¿å•æ¬¡æ‰§è¡Œï¼‰
â”œâ”€â”€ 3. æ ‡å‡†åº“æ”¯æŒ
â”‚   â”œâ”€â”€ 3.1 C++ æ ‡å‡†æ— å†…ç½® ScopeGuard
â”‚   â”œâ”€â”€ 3.2 å¸¸ç”¨å®ç°ï¼šfolly::ScopeGuard, BOOST_SCOPE_EXIT
â”‚   â””â”€â”€ 3.3 C++23 std::scope_guardï¼ˆææ¡ˆä¸­ï¼‰
â”œâ”€â”€ 4. ä¸ Java çš„å¯¹æ¯”
â”‚   â”œâ”€â”€ 4.1 C++ï¼šç¼–è¯‘æœŸè‡ªåŠ¨ï¼ˆRAII + lambdaï¼‰
â”‚   â””â”€â”€ 4.2 Javaï¼šè¿è¡ŒæœŸæ‰‹åŠ¨ï¼ˆtry-finallyï¼‰
â”œâ”€â”€ 5. å¸¸è§ç”¨é€”
    â”œâ”€â”€ 5.1 ä¸´æ—¶èµ„æºæ¸…ç†ï¼ˆå¦‚ä¸´æ—¶æ–‡ä»¶ï¼‰
    â”œâ”€â”€ 5.2 çŠ¶æ€æ¢å¤ï¼ˆå¦‚é‡ç½®æ ‡å¿—ï¼‰
    â””â”€â”€ 5.3 è°ƒè¯•æ—¥å¿—ï¼ˆä½œç”¨åŸŸè¿›å…¥/é€€å‡ºï¼‰
â””â”€â”€ 6. æœ€ä½³å®è·µ
    â”œâ”€â”€ 6.1 ä¼˜å…ˆæ ‡å‡†åº“å®ç°ï¼ˆå¦‚ follyï¼‰
    â”œâ”€â”€ 6.2 æ‰‹åŠ¨å®ç°éœ€ noexcept
    â””â”€â”€ 6.3 é¿å…åœ¨ lambda ä¸­æ•è·å±€éƒ¨å˜é‡ï¼ˆæ‚¬ç©ºé£é™©ï¼‰
```

---

### ğŸ¯ äºŒã€SMART å­¦ä¹ ç›®æ ‡

- **Specific**ï¼šèƒ½æ‰‹åŠ¨å®ç° Scope Guardï¼Œç†è§£å…¶ RAII åŸç†ï¼Œå¹¶ä¸ Java try-finally å¯¹æ¯”ã€‚
- **Measurable**ï¼šå®Œæˆ 2 é“åŸºç¡€é¢˜ + 2 é“é™·é˜±é¢˜ï¼Œèƒ½å®ç°å¼‚å¸¸å®‰å…¨çš„ Scope Guardã€‚
- **Achievable**ï¼šé€šè¿‡â€œè‡ªåŠ¨æ¸…æ´æœºå™¨äººâ€æ¯”å–»ç†è§£ Scope Guardã€‚
- **Relevant**ï¼šè¿™æ˜¯ç¼–å†™ç®€æ´æ¸…ç†ä»£ç çš„é«˜çº§æŠ€å·§ã€‚
- **Time-bound**ï¼š1â€“2 å¤©å†…å®Œæˆã€‚

---

### ğŸŒ ä¸‰ã€ç”Ÿæ´»åŒ–æ¯”å–»ï¼šè‡ªåŠ¨æ¸…æ´æœºå™¨äºº

> æƒ³è±¡ä¸€ä¸ª**è‡ªåŠ¨æ¸…æ´æœºå™¨äºº**ï¼š
>
> - **è¿›å…¥ä½œç”¨åŸŸ = æœºå™¨äººå¯åŠ¨**  
>   - ä½ æ”¾ç½®ä¸€ä¸ªâ€œæ¸…æ´æŒ‡ä»¤â€ï¼ˆlambdaï¼‰
>
> - **ç¦»å¼€ä½œç”¨åŸŸ = æœºå™¨äººè‡ªåŠ¨æ¸…æ´**  
>   - æ— è®ºæ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸ï¼Œæœºå™¨äººéƒ½ä¼šæ‰§è¡Œæ¸…æ´
>
> - **Java å¯¹æ¯”**ï¼š  
>   - Java = **æ‰‹åŠ¨å†™æ¸…æ´æŒ‡ä»¤**ï¼ˆtry-finallyï¼‰  
>   - **C++ = æœºå™¨äººè‡ªåŠ¨æ‰§è¡Œ**ï¼ˆScope Guardï¼‰

> ğŸ’¡ **å…³é”®è®¤çŸ¥**ï¼š**Scope Guard æ˜¯ RAII çš„è½»é‡çº§åº”ç”¨ï¼Œç”¨äºä»»æ„æ¸…ç†é€»è¾‘**ã€‚

---

### ğŸ“š å››ã€çŸ¥è¯†ç‚¹åˆ†è§£

#### 1. åŸºæœ¬æ€æƒ³
- **ä½œç”¨åŸŸç»‘å®š**ï¼š
  - æ¸…ç†ä»£ç åœ¨**ä½œç”¨åŸŸç»“æŸæ—¶è‡ªåŠ¨æ‰§è¡Œ**
- **åŸºäº RAII**ï¼š
  - åˆ©ç”¨ææ„å‡½æ•°è°ƒç”¨ lambda
- **è½»é‡çº§**ï¼š
  - æ— éœ€ä¸ºæ¯ä¸ªæ¸…ç†é€»è¾‘å®šä¹‰å®Œæ•´ RAII ç±»

#### 2. æ‰‹åŠ¨å®ç°
```cpp
// æ‰‹åŠ¨ ScopeGuard å®ç°
template<typename F>
class ScopeGuard {
    F f_;
public:
    explicit ScopeGuard(F f) : f_(std::move(f)) {}
    ~ScopeGuard() noexcept { f_(); }
    
    // ç¦æ­¢æ‹·è´ï¼ˆç¡®ä¿å•æ¬¡æ‰§è¡Œï¼‰
    ScopeGuard(const ScopeGuard&) = delete;
    ScopeGuard& operator=(const ScopeGuard&) = delete;
    
    // å…è®¸ç§»åŠ¨ï¼ˆä½†é€šå¸¸ä¸éœ€è¦ï¼‰
    ScopeGuard(ScopeGuard&&) = default;
};

// è¾…åŠ©å‡½æ•°ï¼ˆè‡ªåŠ¨ç±»å‹æ¨å¯¼ï¼‰
template<typename F>
ScopeGuard<F> make_scope_guard(F f) {
    return ScopeGuard<F>(std::move(f));
}
```

#### 3. æ ‡å‡†åº“æ”¯æŒ
- **C++ æ ‡å‡†**ï¼š
  - **æ— å†…ç½®** ScopeGuardï¼ˆC++23 ææ¡ˆä¸­ï¼‰
- **å¸¸ç”¨åº“**ï¼š
  - **Folly**ï¼ˆFacebookï¼‰ï¼š`folly::makeGuard`
  - **Boost**ï¼š`BOOST_SCOPE_EXIT`
  - **Abseil**ï¼š`absl::Cleanup`

#### 4. ä¸ Java çš„å¯¹æ¯”
| ç‰¹æ€§ | C++ Scope Guard | Java try-finally |
|------|----------------|-----------------|
| **è‡ªåŠ¨åŒ–** | âœ… ç¼–è¯‘æœŸè‡ªåŠ¨ | âš ï¸ éœ€æ˜¾å¼ finally å— |
| **å¼€é”€** | âœ… é›¶å¼€é”€ï¼ˆlambda å†…è”ï¼‰ | âš ï¸ finally å—æœ‰è½»å¾®å¼€é”€ |
| **å¼‚å¸¸å®‰å…¨** | âœ… RAII ç¡®ä¿ | âœ… finally ç¡®ä¿ |
| **çµæ´»æ€§** | âœ… ä»»æ„ lambda | âœ… ä»»æ„ä»£ç  |

#### 5. å¸¸è§ç”¨é€”
- **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼š
  ```cpp
  std::string temp_file = create_temp_file();
  auto guard = make_scope_guard([&] { std::remove(temp_file.c_str()); });
  // ... use temp_file
  // è‡ªåŠ¨åˆ é™¤
  ```
- **çŠ¶æ€æ¢å¤**ï¼š
  ```cpp
  bool old_flag = global_flag;
  global_flag = true;
  auto guard = make_scope_guard([&] { global_flag = old_flag; });
  // ... critical section
  // è‡ªåŠ¨æ¢å¤
  ```
- **è°ƒè¯•æ—¥å¿—**ï¼š
  ```cpp
  auto guard = make_scope_guard([] { std::cout << "Exiting scope\n"; });
  std::cout << "Entering scope\n";
  ```

#### 6. æœ€ä½³å®è·µ
- **ä¼˜å…ˆæ ‡å‡†åº“**ï¼š
  - ç”¨ `folly::makeGuard` æˆ– `absl::Cleanup`
- **æ‰‹åŠ¨å®ç° noexcept**ï¼š
  - ScopeGuard ææ„å‡½æ•°å¿…é¡» `noexcept`
- **é¿å…æ‚¬ç©ºæ•è·**ï¼š
  - lambda ä¸­ä¸è¦æ•è·å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼ˆä½œç”¨åŸŸç»“æŸæ—¶æ‚¬ç©ºï¼‰

> ğŸ’¡ **ç°ä»£ C++ é»„é‡‘æ³•åˆ™**ï¼š  
> **â€œScope Guard = RAII + lambdaï¼›ä¼˜å…ˆæ ‡å‡†åº“ï¼›ææ„ noexceptâ€**

---

### ğŸ’» äº”ã€åŠ¨æ‰‹ä¸ºç‹ï¼šå¯è¿è¡Œç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šæ‰‹åŠ¨ ScopeGuard
```cpp
#include <iostream>
#include <functional>

template<typename F>
class ScopeGuard {
    F f_;
public:
    explicit ScopeGuard(F f) : f_(std::move(f)) {}
    ~ScopeGuard() noexcept { f_(); }
    
    ScopeGuard(const ScopeGuard&) = delete;
    ScopeGuard& operator=(const ScopeGuard&) = delete;
    ScopeGuard(ScopeGuard&&) = default;
};

template<typename F>
ScopeGuard<F> make_scope_guard(F f) {
    return ScopeGuard<F>(std::move(f));
}

void example() {
    std::cout << "Start\n";
    
    auto guard = make_scope_guard([] {
        std::cout << "Cleanup: End of scope\n";
    });
    
    std::cout << "Middle\n";
    // è‡ªåŠ¨æ‰§è¡Œæ¸…ç†
}

int main() {
    example();
    return 0;
}
```
> âœ… **è¾“å‡º**ï¼š
> ```
> Start
> Middle
> Cleanup: End of scope
> ```

#### ç¤ºä¾‹ 2ï¼šå¼‚å¸¸å®‰å…¨
```cpp
#include <iostream>
#include <stdexcept>

void risky_function() {
    auto guard = make_scope_guard([] {
        std::cout << "Cleanup even on exception!\n";
    });
    
    std::cout << "Before exception\n";
    throw std::runtime_error("Oops!");
    std::cout << "After exception\n"; // ä¸ä¼šæ‰§è¡Œ
}

int main() {
    try {
        risky_function();
    } catch (const std::exception& e) {
        std::cout << "Caught: " << e.what() << "\n";
    }
    return 0;
}
```
> âœ… **è¾“å‡º**ï¼š
> ```
> Before exception
> Cleanup even on exception!
> Caught: Oops!
> ```

#### ç¤ºä¾‹ 3ï¼šä¸´æ—¶æ–‡ä»¶æ¸…ç†
```cpp
#include <iostream>
#include <fstream>
#include <string>

std::string create_temp_file() {
    std::string name = "temp.txt";
    std::ofstream file(name);
    file << "Temporary data\n";
    return name;
}

void use_temp_file() {
    std::string temp_file = create_temp_file();
    auto guard = make_scope_guard([&] {
        std::remove(temp_file.c_str());
        std::cout << "Temporary file removed\n";
    });
    
    std::cout << "Using temp file: " << temp_file << "\n";
    // è‡ªåŠ¨æ¸…ç†
}

int main() {
    use_temp_file();
    return 0;
}
```

---

### ğŸ“ å…­ã€åˆ†å±‚ç»ƒä¹ é¢˜

#### ğŸ”¹ åŸºç¡€é¢˜
1. **ScopeGuard å®ç°**  
   - æ‰‹åŠ¨å®ç° `make_scope_guard` å‡½æ•°

2. **è°ƒè¯•æ—¥å¿—**  
   - ç”¨ Scope Guard å®ç°å‡½æ•°è¿›å…¥/é€€å‡ºæ—¥å¿—

#### ğŸ”¸ è¿›é˜¶é¢˜
3. **çŠ¶æ€æ¢å¤**  
   - ç”¨ Scope Guard ä¸´æ—¶ä¿®æ”¹å…¨å±€æ ‡å¿—å¹¶è‡ªåŠ¨æ¢å¤

4. **æ ‡å‡†åº“å¯¹æ¯”**  
   - æ¯”è¾ƒ `folly::makeGuard` ä¸æ‰‹åŠ¨å®ç°

#### âš ï¸ é™·é˜±é¢˜ï¼ˆJava è¿ç§»è¯¯åŒºï¼‰
5. **â€œlambda èƒ½æ•è·å¼•ç”¨å§ï¼Ÿâ€**  
   - Q: Scope Guard çš„ lambda èƒ½æ•è·å±€éƒ¨å˜é‡å¼•ç”¨å—ï¼Ÿ  
   - A: âš ï¸ **å±é™©**ï¼  
     â†’ ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œå±€éƒ¨å˜é‡å·²é”€æ¯ â†’ **æ‚¬ç©ºå¼•ç”¨**

6. **â€œScope Guard æ¯” RAII ç±»æ›´å¥½å§ï¼Ÿâ€**  
   - Q: Scope Guard èƒ½æ›¿ä»£ RAII ç±»å—ï¼Ÿ  
   - A: âš ï¸ **ä¸**ï¼  
     â†’ Scope Guard ç”¨äº**ä¸´æ—¶æ¸…ç†**  
     â†’ RAII ç±»ç”¨äº**èµ„æºå°è£…**ï¼ˆé•¿æœŸæŒæœ‰ï¼‰

---

### âš ï¸ ä¸ƒã€æ³¨æ„äº‹é¡¹ä¸å»ºè®®

| é—®é¢˜ | å»ºè®® |
|------|------|
| **æ‚¬ç©ºå¼•ç”¨** | lambda ä¸­æ•è·å€¼ï¼Œè€Œéå¼•ç”¨ |
| **noexcept** | ScopeGuard ææ„å‡½æ•°å¿…é¡» noexcept |
| **æ ‡å‡†åº“** | ä¼˜å…ˆç”¨ folly/abseil çš„å®ç° |
| **ç°ä»£å®è·µ** | Scope Guard ç”¨äºä¸´æ—¶æ¸…ç†ï¼ŒRAII ç”¨äºèµ„æºå°è£… |

> ğŸ’¡ **ç°ä»£ C++ é»„é‡‘æ³•åˆ™**ï¼š  
> **â€œScope Guard = ä¸´æ—¶æ¸…ç†ï¼›RAII = èµ„æºå°è£…ï¼›lambda æ•è·å€¼ï¼Œé¿å…æ‚¬ç©ºâ€**

---

### ğŸ” å…«ã€èºæ—‹å¤ä¹ 

- **è¡”æ¥ 2.3.6**ï¼šScope Guard æ˜¯ RAII çš„è½»é‡çº§åº”ç”¨  
- **Java ç»éªŒ**ï¼šC++ Scope Guard æ¯” Java try-finally æ›´è‡ªåŠ¨  
- **å½“æ—¥å¤ä¹ **ï¼šé»˜å†™ Scope Guard çš„ä¸‰å¤§ç”¨é€”

---

### ğŸ§  ä¹ã€ä¸»åŠ¨ learning ä»»åŠ¡

1. **è‡ªæˆ‘æé—®**ï¼š
   - â€œå¦‚ä½•ç”¨ Scope Guard å®ç°æ€§èƒ½è®¡æ—¶å™¨ï¼Ÿâ€
   - â€œC++23 std::scope_guard æœ‰ä½•æ”¹è¿›ï¼Ÿâ€
2. **æ¦‚å¿µå›¾**ï¼šç”»å‡º Scope Guard ä¸ RAII ç±»çš„é€‚ç”¨åœºæ™¯å¯¹æ¯”
3. **æ‰®æ¼”æ•™å¸ˆ**ï¼šå‘åŒäº‹è§£é‡Šâ€œä¸ºä»€ä¹ˆ lambda æ•è·å¼•ç”¨åœ¨ Scope Guard ä¸­å±é™©â€

---

### ğŸ” åã€å¤ç›˜æ¸…å•

âœ… æˆ‘èƒ½æ‰‹åŠ¨å®ç° Scope Guard  
âœ… æˆ‘ç†è§£å…¶ RAII åŸç†  
âœ… æˆ‘ä¼šç”¨äºä¸´æ—¶æ¸…ç†åœºæ™¯  
âœ… æˆ‘çŸ¥é“ä¸ Java try-finally çš„å·®å¼‚  
âœ… æˆ‘æ˜ç™½ç°ä»£ C++ çš„ Scope Guard æœ€ä½³å®è·µ

> ğŸ¯ **è¾¾æ ‡æ ‡å‡†**ï¼šå®ŒæˆåŸºç¡€é¢˜ + æ­£ç¡®åˆ†æé™·é˜±é¢˜ 5 å’Œ 6

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

ä½ å·²æŒæ¡ **C++ Scope Guard æ¨¡å¼çš„æ ¸å¿ƒçŸ¥è¯†**ï¼

æ¥ä¸‹æ¥ä½ å¯ä»¥ï¼š
1. **ç»§ç»­å­¦ä¹  2.4 æ‹·è´æ„é€ å‡½æ•°ä¸æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼ˆæ·±æ‹·è´ vs æµ…æ‹·è´ï¼‰**
2. **è¯·æ±‚ç”Ÿæˆã€ŒC++ Scope Guard é€ŸæŸ¥å¡ã€**
3. **è·³è½¬åˆ°ç»ƒä¹ é¢˜ç­”æ¡ˆä¸è§£æ**

è¯·å‘Šè¯‰æˆ‘ä½ çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å°†ç»§ç»­å‰è¡Œï¼