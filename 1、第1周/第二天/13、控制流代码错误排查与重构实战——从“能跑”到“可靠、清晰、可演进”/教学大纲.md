### 第 1 周第 2 天 18:30–20:00 阶段详细教学内容大纲  
**阶段标题：控制流代码错误排查与重构实战——从“能跑”到“可靠、清晰、可演进”**

---

#### **本阶段学习目标**  
1. 能系统性地诊断一段“能编译但逻辑错误”的控制流程序，定位问题根源（如边界遗漏、条件错、无限循环）；  
2. 掌握代码重构的基本原则：**行为不变、结构优化、可读性提升**，尤其针对控制流逻辑；  
3. 运用条件拆分、循环简化、注释补充等手段，将模糊控制流显式化；  
4. 初步建立“防御性编程”意识：通过边界测试、输入验证预防控制流错误；  
5. 为未来多文件项目（第 3 天起）做好代码组织与接口设计的思维准备。

---

#### **本阶段知识点覆盖与整合**

| 知识模块 | 在本阶段的应用 |
|--------|--------------|
| 逻辑错误识别（13:30–15:00） | 定位循环边界、条件优先级、布尔逻辑错误 |
| 控制流风格（12:00–13:30） | 重构复杂条件、限制嵌套、注释 `break` / `continue` |
| 输入验证（03:30–04:30） | 增强输入提示与错误反馈 |
| 头文件概念（16:30–18:00） | 为未来函数提取埋下“接口分离”伏笔 |

---

#### **本阶段核心任务：菜单系统诊断与重构**

##### 原始“病态代码”（功能：带重试的菜单系统）
```cpp
#include <iostream>
using namespace std;
int main() {
    while (true) {
        cout << "1:Greet 2:Convert 3:Exit: ";
        int c; cin >> c;
        if (c = 1) {
            string n; int a; cin >> n >> a;
            cout << "Hi " << n << ", " << a << "\n";
        } else if (c == 2) {
            double v; cin >> v;
            if (cin.fail()) continue;
            cout << v * 2.54 << "\n";
        } else if (c == 3) {
            break;
        }
    }
    return 0;
}
```

##### 典型问题分析
| 问题类型 | 具体表现 | 后果 |
|--------|--------|------|
| **逻辑错误** | `if (c = 1)` 为赋值而非比较 | 选项 1 恒执行，其他选项失效 |
| **运行时错误** | `cin.fail()` 后未 `clear()` / `ignore()` | 无限循环（输入字母后） |
| **风格缺陷** | 无缩进、无空格、无注释、`using namespace std` | 阅读体验差，易改错 |
| **输入缺陷** | 无输入提示、无选项验证（如输入 4 无提示） | 用户体验差 |
| **潜在风险** | 无边界测试（如负数长度） | 逻辑脆弱 |

---

#### **本阶段重构目标与规范**

##### 功能正确性
- 修复赋值错误：`if (c == 1)`；  
- 修复输入错误：`cin.fail()` 后加 `clear()` + `ignore()`；  
- 增加选项验证：输入 4 应提示“Invalid option”。

##### 代码可读性
- 变量命名：`userChoice`, `userName`, `userAge`；  
- 条件拆分：`bool is_greet = (userChoice == 1);`；  
- 2 空格缩进，运算符加空格；  
- 为 `continue` / `break` 添加注释。

##### 用户体验
- 输入前有明确提示；  
- 错误输入有具体提示（“Not a number” vs “Invalid option”）；  
- 退出时有“Goodbye!”。

##### 工程规范
- 移除 `using namespace std;`，改用 `std::`；  
- 逻辑分块：菜单显示 / 输入处理 / 选项分发 / 错误处理；  
- 为未来提取函数做准备（如 `handleGreeting()`, `handleConversion()`）。

---

#### **本阶段动手练习任务**

- **【核心任务】错误诊断与重构（60 分钟）**  
  1. **诊断**：运行原始代码，输入 `abc` 观察无限循环，输入 `2` 后 `abc` 观察跳过；  
  2. **修复**：修正赋值错误、输入错误处理、选项验证；  
  3. **重构**：按上述规范重写代码，提升可读性与健壮性；  
  4. **测试**：覆盖正常路径与异常输入（字母、4、负数）。

- **【进阶任务】为函数化做准备（20 分钟）**  
  - 在注释中标注：“// TODO: 第 3 天将提取为 handleGreeting () 等函数”；  
  - 思考：如果要支持“历史记录”，哪些逻辑应独立？（答案：转换计算）

- **【陷阱任务】边界测试（10 分钟）**  
  - 测试极端值：输入 `-1` 作为长度，观察是否处理；  
  - 测试 `0` 作为选项，观察是否提示无效；  
  - 观察浮点精度是否可接受（不要求精确控制，仅建立意识）。

---

#### **跨阶段综合小测/项目**  
- 本阶段重构成果将作为 **第 3 天“函数封装”项目的起点**：  
  - 学生需将此处的选项逻辑提取为独立函数；  
  - 项目评审将检查是否保留清晰接口与命名；  
- 若未修复赋值错误或输入验证，将在第 3 天函数提取时暴露更大维护成本。

---

#### **与前后阶段的知识衔接说明**

- **前置依赖**：综合运用 13:30–18:00 所学（错误分类、风格规范、头文件意识）；  
- **后继支撑**：  
  - 20:00–21:30 的“当日知识全景复盘”将包含本阶段重构要点；  
  - 第 3 天“函数封装”将直接基于此重构代码提取函数；  
- **螺旋上升点**：  
  - 第 8 周“类设计”将把菜单系统封装为 `Menu` 类；  
  - 第 11 周“综合项目”将要求所有逻辑模块化、接口清晰，回溯本阶段的“可演进”思想。

--- 

> 本阶段标志着学生从“控制流实现者”向“软件设计师”的初步转变。重构不是重写，而是**在不改变行为的前提下，让代码更易理解、更易修改、更少出错**。必须通过亲手修复隐蔽的逻辑错误、优化模糊命名，建立对代码质量的工程级敏感度。今天多花 10 分钟写清楚，未来少花 1 小时 debug。