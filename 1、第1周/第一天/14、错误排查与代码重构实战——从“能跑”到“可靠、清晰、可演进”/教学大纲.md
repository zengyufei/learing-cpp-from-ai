## **错误排查与代码重构实战——从“能跑”到“可靠、清晰、可演进”**

---

#### **本阶段学习目标**  
1. 能系统性地诊断一段“能编译但逻辑错误”的程序，定位问题根源；  
2. 掌握代码重构的基本原则：**行为不变、结构优化、可读性提升**；  
3. 运用变量命名、表达式拆分、注释补充等手段，将模糊逻辑显式化；  
4. 初步建立“防御性编程”意识：通过输入验证、边界测试预防错误；  
5. 为未来多文件项目（第 3 周起）做好代码组织与接口设计的思维准备。

---

#### **本阶段知识点覆盖与整合**

| 知识模块 | 在本阶段的应用 |
|--------|--------------|
| 逻辑错误识别（15:00–16:30） | 定位公式错误、类型误用、运算顺序问题 |
| 类型与转换（10:30–12:00） | 修复整数除法、浮点精度丢失 |
| 代码风格（13:30–15:00） | 重命名变量、格式化、添加解释性注释 |
| 输入输出（06:00–07:30） | 增强输入提示与错误反馈 |
| 头文件概念（18:00–19:30） | 为未来函数提取埋下“接口分离”伏笔 |

---

#### **本阶段核心任务：温度转换程序诊断与重构**

##### 原始“病态代码”（功能：华氏 ↔ 摄氏双向转换）
```cpp
#include <iostream>
using namespace std;
int main() {
    int mode;
    cout << "1:F2C 2:C2F: ";
    cin >> mode;
    double t;
    cin >> t;
    double r;
    if (mode == 1) {
        r = (t - 32) * 5 / 9;
    } else {
        r = t * 9 / 5 + 32;
    }
    cout << r << endl;
    return 0;
}
```

##### 典型问题分析
| 问题类型 | 具体表现 | 后果 |
|--------|--------|------|
| **逻辑错误** | `5 / 9` 为整数除法 → 结果为 0 | 华氏转摄氏恒为 0 |
| **命名模糊** | `mode`, `t`, `r` 无业务含义 | 难以理解、易改错 |
| **风格缺陷** | 无缩进、无空格、无注释 | 阅读体验差 |
| **输入缺陷** | 无输入提示、无错误处理 | 用户体验差，易崩溃 |
| **潜在风险** | `using namespace std;` | 命名污染（虽本阶段影响小，但需纠正） |

---

#### **本阶段重构目标与规范**

##### 功能正确性
- 修复整数除法：`5.0 / 9.0`；  
- 确保双向转换公式正确：
  - F → C: `(F - 32) * 5.0 / 9.0`  
  - C → F: `C * 9.0 / 5.0 + 32`

##### 代码可读性
- 变量命名：`conversionMode`, `inputTemp`, `resultTemp`；  
- 常量命名：`FAHRENHEIT_TO_CELSIUS_FACTOR`；  
- 2 空格缩进，运算符加空格；  
- 添加注释说明转换公式。

##### 用户体验
- 输入前有明确提示；  
- 选项输入后提示“请输入温度值”；  
- （可选）检测 `cin.fail()` 并报错。

##### 工程规范
- 移除 `using namespace std;`，改用 `std::`；  
- 逻辑分块：输入处理 / 转换计算 / 结果输出；  
- 为未来提取函数做准备（如 `fahrenheitToCelsius(double)`）。

---

#### **本阶段动手练习任务**

- **【核心任务】错误诊断与重构（60 分钟）**  
  1. **诊断**：运行原始代码，输入 `1` 和 `32`，观察输出（应为 0，但因 `5/9=0` 得 0，看似正确；输入 `212` 应得 100，实际得 0 → 暴露错误）；  
  2. **修复**：修正整数除法，验证 `212 → 100`、`100 → 212`；  
  3. **重构**：按上述规范重写代码，提升可读性与健壮性；  
  4. **测试**：覆盖正常路径与异常输入（如字母）。

- **【进阶任务】为函数化做准备（20 分钟）**  
  - 在注释中标注：“// TODO: 第 3 周将提取为 fahrenheitToCelsius (double) 函数”；  
  - 思考：如果要支持开尔文温度，代码哪些部分需要改动？（答案：转换逻辑应独立）

- **【陷阱任务】边界测试（10 分钟）**  
  - 测试极端值：`-459.67°F`（绝对零度）应得 `-273.15°C`；  
  - 测试 `0°C` → `32°F`；  
  - 观察浮点精度是否可接受（不要求精确控制，仅建立意识）。

---

#### **跨阶段综合小测/项目**  
- 本阶段重构成果将作为 **第 3 周“函数封装”项目的起点**：  
  - 学生需将此处的转换逻辑提取为独立函数；  
  - 项目评审将检查是否保留清晰接口与命名；  
- 若未修复整数除法或命名混乱，将在第 3 周函数提取时暴露更大维护成本。

---

#### **与前后阶段的知识衔接说明**

- **前置依赖**：综合运用 15:00–19:30 所学（错误分类、类型转换、风格规范、头文件意识）；  
- **后继支撑**：  
  - 21:00–22:30 的“当日知识全景复盘”将包含本阶段重构要点；  
  - 第 3 周“函数封装”将直接基于此重构代码提取函数；  
- **螺旋上升点**：  
  - 第 8 周“类设计”将把温度转换封装为 `Temperature` 类；  
  - 第 11 周“综合项目”将要求所有逻辑模块化、接口清晰，回溯本阶段的“可演进”思想。

--- 

> 本阶段标志着学生从“功能实现者”向“软件设计师”的初步转变。重构不是重写，而是**在不改变行为的前提下，让代码更易理解、更易修改、更少出错**。必须通过亲手修复隐蔽的逻辑错误、优化模糊命名，建立对代码质量的工程级敏感度。今天多花 10 分钟写清楚，未来少花 1 小时 debug。